#!/usr/bin/env php
<?php
/**
 * Copyright Â© 2011 Online Buddies, Inc. - All Rights Reserved
 *
 * @package Modyllic
 * @author bturner@online-buddies.com
 */

require_once "Modyllic/CommandLine.php";
require_once "Modyllic/Generator.php";
require_once "Modyllic/Diff.php";
require_once "Modyllic/SQL.php";
require_once "Modyllic/Loader/DB.php";

$args = Modyllic_CommandLine::getArgs(array(
    'description' => 'Generate a PHP helper class for the stored procs in the schema',
    'options' => array(
        'fromschema' => array(
            'short_name'  => '-f',
            'long_name'   => '--from',
            'action'      => 'StoreString',
            'description' => 'The DSN of the database to update',
            ),
        'toschema' => array(
            'short_name'  => '-t',
            'long_name'   => '--to',
            'action'      => 'StoreArray',
            'description' => 'The schema to update the database to match',
            ),
        'create' => array(
            'long_name'   => '--create',
            'description' => 'create the database if its missing',
            'action'      => 'StoreTrue',
            ) ),
        ));

if ( ! isset($args->options['fromschema']) ) {
    Modyllic_CommandLine::displayError( 'the fromschema is required');
}
if ( ! isset($args->options['toschema']) ) {
    Modyllic_CommandLine::displayError( 'the toschema is required');
}

if ( ! Modyllic_Loader_DB::is_dsn($args->options['fromschema']) ) {
    Modyllic_CommandLine::displayError( 'the fromschema must be a database');
}

list( $driver, $dsn, $dbname, $user, $pass ) = Modyllic_Loader_DB::parse_dsn($args->options['fromschema']);

$dbh = new PDO( $dsn, $user, $pass, array( PDO::ATTR_ERRMODE=>PDO::ERRMODE_EXCEPTION ) );
$sth = $dbh->prepare('SELECT COUNT(*) FROM information_schema.SCHEMATA WHERE SCHEMA_NAME=?');
$sth->execute(array($dbname));
list($count) = $sth->fetch(PDO::FETCH_NUM);
if ( $count == 0 ) {
    if ( $args->options['create'] ) {
        $dbh->exec("CREATE DATABASE ".Modyllic_SQL::quote_ident($dbname));
    }
    else {
        Modyllic_CommandLine::displayError( 'could not connect to database '.$dbname );
    }
}

try {
    $gen_class = Modyllic_Generator::dialectToClass($driver);
}
catch (Exception $e) {
    /// @todo This should probably just fail out and not default to "SQL".
    /// Also, SQL is really MySQL
    $gen_class = Modyllic_Generator::dialectToClass("SQL");
}

$from = Modyllic_CommandLine::schema( array($args->options['fromschema']) );

$to   = Modyllic_CommandLine::schema($args->options['toschema']);

Modyllic_Status::verbose("Comparing...\n");
$diff = new Modyllic_Diff( $from, $to );

if ( ! $diff->changeset->has_changes() ) {
    Modyllic_Status::verbose("No changes detected.\n");
    exit(0);
}

$dbh->exec("USE ".Modyllic_SQL::quote_ident($dbname));

$gen = new $gen_class();
foreach ( $gen->sql_header() as $sql ) {
    $dbh->exec( $sql );
}
$gen->alter($diff);
$cmds = count($gen->sql_commands());
try {
    $ii = 0;
    Modyllic_Status::$sourceName = "changes into database";
    Modyllic_Status::$sourceCount = 1;
    Modyllic_Status::$sourceIndex = 1;
    foreach ($gen->sql_commands() as $cmd) {
        Modyllic_Status::status( ++$ii, $cmds );
        $dbh->exec($cmd);
    }
}
catch (PDOException $e) {
    Modyllic_Status::clear_progress();
    print $e->getMessage()."\n";
    print "Full context of command:\n";
    print $cmd."\n";
    exit(1);
}
Modyllic_Status::clear_progress();
Modyllic_Status::verbose("Database updated");
